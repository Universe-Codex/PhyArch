<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PhyArch Omni v2.3</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

    <style>
        :root { --bg: #050508; --panel: #111116; --accent: #00ff88; --border: #2a2a2a; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', monospace; }
        body { background:var(--bg); color:#eee; display:flex; flex-direction:column; height:100vh; overflow:hidden; }
        
        header { background:var(--panel); border-bottom:1px solid var(--border); padding:10px 20px; display:flex; justify-content:space-between; align-items:center; z-index:10; font-size:14px;}
        .status-light { display:inline-block; width:8px; height:8px; border-radius:50%; background:#333; margin-right:5px; transition: 0.3s; }
        .active { background:var(--accent); box-shadow:0 0 10px var(--accent); }
        
        #viewport { flex-grow:1; position:relative; background:#000; }
        
        #console-panel { background:var(--panel); border-top:1px solid var(--border); height:30%; display:flex; flex-direction:column; }
        #log-output { flex-grow:1; padding:15px; overflow-y:auto; font-size:12px; background:#09090b; color:#888; border-bottom: 1px solid var(--border); }
        
        .input-area { display:flex; padding:12px; gap:10px; background:rgba(0,0,0,0.5); }
        input[type="text"] { flex-grow:1; background:#1a1a1f; border:1px solid var(--border); color:var(--accent); padding:12px 18px; border-radius:6px; outline:none; font-size:14px; }
        input[type="text"]:focus { border-color: var(--accent); }
        
        button { background:var(--panel); color:white; border:1px solid var(--border); padding:10px 18px; border-radius:6px; cursor:pointer; font-size:11px; font-weight:bold; text-transform:uppercase; transition: 0.2s; }
        button:hover { background: #1c1c24; border-color: #444; }
        button:active { background:var(--accent); color:black; }
        
        .button-row { display:flex; gap:10px; padding:10px 15px; flex-wrap:wrap; background:#0a0a0e; border-top: 1px solid #111; }
        .btn-special { border-width: 1px; flex: 1; min-width: 90px;}
        .hint { position: absolute; bottom: 32%; right: 20px; color: #444; font-size: 10px; pointer-events: none;}
    </style>
</head>
<body>

<header>
    <div style="letter-spacing: 2px;">PHYARCH <span style="color:var(--accent)">OMNI</span> v2.3</div>
    <div>
        <span id="ind-py" class="status-light"></span> PY
        <span id="ind-phys" class="status-light" style="margin-left:10px;"></span> PHYS
        <button id="save-btn" style="margin-left:15px; padding: 4px 8px;">SAVE STATE</button>
        <button id="clear-btn" style="margin-left:5px; padding: 4px 8px;">RESET</button>
    </div>
</header>

<main id="viewport"></main>
<div class="hint">Right-click to Rotate | Scroll to Zoom</div>

<section id="console-panel">
    <div id="log-output"></div>
    <div class="input-area">
        <input type="text" id="physics-input" placeholder="Try: 'viz [1,5,2,8,3]', 'build solar', or 'solve x^2=16'..." autocomplete="off">
        <button id="inject-btn">PROCESS</button>
    </div>
    <div class="button-row">
        <button id="btn-ai" class="btn-special" style="border-color:#00ff88;">AI BOT</button>
        <button id="btn-fixer" class="btn-special" style="border-color:#ff8800;">FIXER</button>
        <button id="btn-social" class="btn-special" style="border-color:#0088ff;">SOCIAL</button>
        <button id="btn-writer" class="btn-special" style="border-color:#ff00ff;">WRITER</button>
        <button id="btn-search" class="btn-special" style="border-color:#00ffff;">SEARCH</button>
    </div>
</section>

<script id="vertexShader" type="x-shader/x-vertex">
    varying vec2 vUv;
    varying vec3 vNormal;
    uniform float time;
    void main() {
        vUv = uv;
        vNormal = normal;
        // Pulse effect: move vertices along normals based on time
        vec3 newPosition = position + normal * sin(position.y * 2.0 + time * 3.0) * 0.15;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);
    }
</script>

<script id="fragmentShader" type="x-shader/x-fragment">
    varying vec2 vUv;
    varying vec3 vNormal;
    uniform float time;
    void main() {
        float pulse = (sin(time * 2.0) + 1.0) / 2.0;
        vec3 baseColor = vec3(0.0, 1.0, 0.53); // The accent green
        vec3 finalColor = baseColor * (vNormal.z + 0.5) + (pulse * 0.2);
        gl_FragColor = vec4(finalColor, 0.8);
    }
</script>

<script>
/* =====================================================================
   1. ADVANCED PHYSICS CLASS (Collisions Added)
===================================================================== */
class PhysicsObject {
    constructor(mesh, options = {}) {
        this.mesh = mesh;
        this.radius = options.size * 0.8 || 1.2;
        this.velocity = options.velocity || new THREE.Vector3();
        this.gravity = -0.015;
        this.bounce = 0.7;
        this.id = Math.random().toString(36).substring(7);
        this.type = options.type || 'box';
    }

    update(allObjects) {
        this.velocity.y += this.gravity;
        this.mesh.position.add(this.velocity);

        // Floor Collision
        if (this.mesh.position.y < this.radius) {
            this.mesh.position.y = this.radius;
            this.velocity.y *= -this.bounce;
        }

        // Object-to-Object Collision (Basic Sphere-Check)
        allObjects.forEach(other => {
            if (other.id === this.id) return;
            let dist = this.mesh.position.distanceTo(other.mesh.position);
            let minDist = this.radius + other.radius;
            
            if (dist < minDist) {
                // Collision response (Elastic bounce)
                let collisionNormal = this.mesh.position.clone().sub(other.mesh.position).normalize();
                this.velocity.add(collisionNormal.multiplyScalar(0.05));
                this.mesh.position.add(collisionNormal.multiplyScalar(0.01));
            }
        });

        this.mesh.rotation.x += 0.01;
    }
}

/* =====================================================================
   2. OMNI ENGINE
===================================================================== */
const Omni = {
    scene: null, camera: null, renderer: null, controls: null,
    objects: [], py: null, coreShaderMat: null,

    log(msg, color = "#888") {
        const out = document.getElementById('log-output');
        const d = document.createElement('div');
        d.style.color = color;
        d.textContent = `[${new Date().toLocaleTimeString()}] > ${msg}`;
        out.appendChild(d);
        out.scrollTop = out.scrollHeight;
    },

    init() {
        const vp = document.getElementById('viewport');
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(50, vp.clientWidth/vp.clientHeight, 0.1, 1000);
        this.camera.position.set(25, 25, 25);

        this.renderer = new THREE.WebGLRenderer({ antialias: true });
        this.renderer.setSize(vp.clientWidth, vp.clientHeight);
        vp.appendChild(this.renderer.domElement);

        // UPGRADE: Orbit Controls
        this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
        this.controls.enableDamping = true;

        this.scene.add(new THREE.AmbientLight(0xffffff, 0.4));
        const pLight = new THREE.PointLight(0x00ff88, 1, 100);
        pLight.position.set(10, 20, 10);
        this.scene.add(pLight);

        // UPGRADE: GLSL Shader Material for Core
        this.coreShaderMat = new THREE.ShaderMaterial({
            vertexShader: document.getElementById('vertexShader').textContent,
            fragmentShader: document.getElementById('fragmentShader').textContent,
            uniforms: { time: { value: 0 } },
            transparent: true,
            wireframe: true
        });

        const core = new THREE.Mesh(new THREE.IcosahedronGeometry(4, 2), this.coreShaderMat);
        this.scene.add(core);

        document.getElementById('ind-phys').classList.add('active');
        this.log("Omni Engine Online. Camera Unlocked.", "#00ff88");
        this.loadState();
        this.animate();
    },

    spawn(type, options = {}) {
        let geo;
        const size = options.size || 1.5;
        if (type === 'sphere') geo = new THREE.SphereGeometry(size, 16, 16);
        else if (type === 'torus') geo = new THREE.TorusGeometry(size, 0.4, 12, 24);
        else geo = new THREE.BoxGeometry(size, size, size);

        const mat = new THREE.MeshPhongMaterial({ color: options.color || 0x00ff88, wireframe: true });
        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.copy(options.pos || new THREE.Vector3((Math.random()-0.5)*10, 15, (Math.random()-0.5)*10));
        
        this.scene.add(mesh);
        const pObj = new PhysicsObject(mesh, { size, type, color: options.color });
        this.objects.push(pObj);
    },

    animate() {
        requestAnimationFrame(() => this.animate());
        const time = performance.now() * 0.001;
        if(this.coreShaderMat) this.coreShaderMat.uniforms.time.value = time;
        
        this.objects.forEach(o => o.update(this.objects));
        this.controls.update();
        this.renderer.render(this.scene, this.camera);
    },

    /* UPGRADE: Data Viz - Python to Geometry */
    async pythonViz(dataArray) {
        this.log("Mapping Data Array to 3D Space...", "yellow");
        dataArray.forEach((val, i) => {
            setTimeout(() => {
                this.spawn('box', { 
                    size: val * 0.5, 
                    pos: new THREE.Vector3(i * 3 - (dataArray.length), 10, 0),
                    color: 0x0088ff 
                });
            }, i * 100);
        });
    },

    /* UPGRADE: Persistence */
    saveState() {
        const data = this.objects.map(o => ({
            type: o.type,
            pos: o.mesh.position,
            color: o.mesh.material.color.getHex(),
            size: o.radius / 0.8
        }));
        localStorage.setItem('phyarch_state', JSON.stringify(data));
        this.log("World State Saved to LocalStorage.", "#00ff88");
    },

    loadState() {
        const saved = localStorage.getItem('phyarch_state');
        if (!saved) return;
        const data = JSON.parse(saved);
        data.forEach(d => this.spawn(d.type, { pos: d.pos, color: d.color, size: d.size }));
        this.log(`Reconstructed ${data.length} objects from last session.`, "yellow");
    }
};

/* =====================================================================
   3. SYSTEM BOOT & LISTENERS
===================================================================== */
(async function boot() {
    Omni.init();
    try {
        Omni.py = await loadPyodide();
        document.getElementById('ind-py').classList.add('active');
        Omni.log("Python Intelligence Linked.", "#00ff88");
    } catch(e) {}
})();

const handleInput = async () => {
    const input = document.getElementById('physics-input');
    const val = input.value.trim().toLowerCase();
    if (!val) return;

    if (val.startsWith("viz")) {
        // Simple regex to grab the array from text like "viz [1,2,3]"
        const arr = JSON.parse(val.match(/\[.*\]/)[0]);
        Omni.pythonViz(arr);
    } else if (val.includes("solar")) {
        Omni.spawn('sphere', { size: 5, color: 0xffff00 }); // Sun
        for(let i=0; i<5; i++) Omni.spawn('sphere', { size: 1, color: 0x4488ff });
    } else if (Omni.py && /[\+\-\*\/\^=]/.test(val)) {
        const res = await Omni.py.runPythonAsync(`str(eval("${val.replace('^','**')}"))`);
        Omni.log(`Python Result: ${res}`, "#00ff88");
        Omni.spawn('torus', { size: parseFloat(res) || 2 });
    } else {
        Omni.spawn('box', { size: 2 });
    }
    input.value = "";
};

// Listeners
document.getElementById('inject-btn').addEventListener('click', handleInput);
document.getElementById('save-btn').addEventListener('click', () => Omni.saveState());
document.getElementById('clear-btn').addEventListener('click', () => {
    localStorage.removeItem('phyarch_state');
    location.reload();
});
document.getElementById('physics-input').addEventListener('keypress', e => e.key==='Enter' && handleInput());

// Utility for Export Buttons (Inventions)
document.querySelectorAll('.btn-special').forEach(btn => {
    btn.addEventListener('click', () => {
        const name = btn.textContent;
        Omni.log(`Bithing ${name} Invention...`, "magenta");
        // Reuse your export logic from previous versions here
    });
});

window.addEventListener('resize', () => {
    const vp = document.getElementById('viewport');
    Omni.camera.aspect = vp.clientWidth / vp.clientHeight;
    Omni.camera.updateProjectionMatrix();
    Omni.renderer.setSize(vp.clientWidth, vp.clientHeight);
});
</script>
</body>
</html>===================================================================== */
const PhyArch = {
    scene: null,
    camera: null,
    renderer: null,
    coreMesh: null,
    objects: [],
    py: null,

    log(msg, color = "#aaa") {
        const logWindow = document.getElementById('log-output');
        const div = document.createElement('div');
        div.style.color = color;
        div.textContent = `> ${msg}`; // TextContent is safer than InnerHTML
        logWindow.appendChild(div);
        logWindow.scrollTop = logWindow.scrollHeight;
    },

    initThree() {
        const vp = document.getElementById('viewport');
        this.scene = new THREE.Scene();
        this.scene.fog = new THREE.FogExp2(0x0a0a0c, 0.035);

        this.camera = new THREE.PerspectiveCamera(60, vp.clientWidth / vp.clientHeight, 0.1, 200);
        this.camera.position.set(12, 18, 22);
        this.camera.lookAt(0, 5, 0);

        this.renderer = new THREE.WebGLRenderer({ antialias: true });
        this.renderer.setSize(vp.clientWidth, vp.clientHeight);
        vp.appendChild(this.renderer.domElement);

        this.scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const light = new THREE.DirectionalLight(0xffeecc, 1);
        light.position.set(10, 20, 10);
        this.scene.add(light);

        // Grid Floor
        const grid = new THREE.GridHelper(80, 40, 0x333333, 0x222222);
        this.scene.add(grid);

        // Core AI Heart
        const coreGeo = new THREE.IcosahedronGeometry(3.2, 1);
        const coreMat = new THREE.MeshPhongMaterial({ color: 0x00ff88, wireframe: true, emissive: 0x00ff88, emissiveIntensity: 0.4 });
        this.coreMesh = new THREE.Mesh(coreGeo, coreMat);
        this.scene.add(this.coreMesh);

        document.getElementById('ind-phys').classList.add('active');
        this.log("Physics Engine Initialized.", "#00ff88");
        this.animate();
    },

    async initPython() {
        this.log("Waking SymPy Core...", "yellow");
        try {
            this.py = await loadPyodide();
            await this.py.loadPackage(["micropip"]);
            const micropip = this.py.pyimport("micropip");
            await micropip.install(['sympy', 'numpy']);
            document.getElementById('ind-py').classList.add('active');
            this.log("Python Intelligence Linked.", "#00ff88");
        } catch (e) { this.log("Python Error: " + e.message, "red"); }
    },

    spawn(type = 'box', count = 1, options = {}) {
        for (let i = 0; i < count; i++) {
            const size = options.size || 1.5;
            let geo;
            if (type === 'sphere') geo = new THREE.SphereGeometry(size, 24, 24);
            else if (type === 'torus') geo = new THREE.TorusGeometry(size, size * 0.3, 16, 32);
            else geo = new THREE.BoxGeometry(size, size, size);

            const mat = new THREE.MeshPhongMaterial({ color: options.color || (Math.random() * 0xffffff), wireframe: true });
            const mesh = new THREE.Mesh(geo, mat);
            
            mesh.position.set((Math.random() - 0.5) * 15, 12 + Math.random() * 5, (Math.random() - 0.5) * 15);
            this.scene.add(mesh);

            const vel = new THREE.Vector3((Math.random() - 0.5) * 0.4, 0.5, (Math.random() - 0.5) * 0.4);
            const pObj = new PhysicsObject(mesh, { size, velocity: vel });
            this.objects.push(pObj);
        }
        this.log(`Master AI: Processed ${count} entities.`, "#00ff88");
    },

    animate() {
        requestAnimationFrame(() => this.animate());
        
        // Clean Loop (Gemini Suggestion)
        this.objects.forEach(obj => obj.update());
        
        if (this.coreMesh) this.coreMesh.rotation.y += 0.005;
        this.renderer.render(this.scene, this.camera);
    }
};

/* =====================================================================
   3. INVENTION FACTORY
===================================================================== */
const Factory = {
    templates: {
        ai: `document.body.innerHTML = '<div style="padding:40px; background:#000; color:#0f0; height:100vh; font-family:monospace;"><h1>AI BOT</h1><div id="c" style="height:70%; overflow:auto; border:1px solid #0f0; padding:10px; margin-bottom:10px;"></div><input id="i" style="width:80%; background:#222; border:1px solid #0f0; color:#0f0;"><button onclick="document.getElementById(\\'c\\').innerHTML += \\'<div>User: \\' + document.getElementById(\\'i\\').value + \\'</div>\\'; document.getElementById(\\'i\\').value=\\'\\';">SEND</button></div>';`,
        fixer: `document.body.innerHTML = '<div style="padding:40px; background:#111; color:#ff8800; height:100vh;"><h1>ARCHITECT FIXER</h1><textarea style="width:100%; height:80%; background:#000; color:#ff8800; border:2px solid #ff8800;">// Paste broken logic here...</textarea></div>';`,
        writer: `document.body.innerHTML = '<div style="padding:40px; height:100vh; background:#f0f0f0; color:#000;"><h1 contenteditable="true">Master Manuscript</h1><div contenteditable="true" style="margin-top:20px; outline:none;">Start writing...</div></div>';`,
        search: `const search = async () => { const q = document.getElementById('q').value; const r = await fetch('https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=' + q + '&format=json&origin=*'); const d = await r.json(); document.getElementById('res').innerHTML = d.query.search.map(s => '<li>'+s.title+'</li>').join(''); }; document.body.innerHTML = '<div style="padding:40px; background:#001; color:#0ff; height:100vh;"><h1>SEARCH ENGINE</h1><input id="q"><button onclick="search()">FIND</button><ul id="res"></ul></div>';`,
        social: `document.body.innerHTML = '<div style="padding:40px; background:#002244; color:white; height:100vh;"><h1>SOCIAL PULSE</h1><div style="background:rgba(255,255,255,0.1); padding:20px;">@MasterBuilder: The world is code.</div></div>';`
    },

    export(name, type) {
        PhyArch.log(`Birthed Invention: ${name}`, "yellow");
        const logic = this.templates[type] || `document.body.innerHTML = '<h1>Invention: ${name}</h1>';`;
        const content = `<!DOCTYPE html><html><head><title>${name}</title></head><body><script>${logic}<\/script></body></html>`;
        const blob = new Blob([content], { type: 'text/html' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${name.replace(/\s/g, '_')}.html`;
        link.click();
    }
};

/* =====================================================================
   4. EVENT LISTENERS (Programmatic - Gemini Suggestion)
===================================================================== */
async function processInput() {
    const input = document.getElementById('physics-input');
    const val = input.value.trim().toLowerCase();
    if (!val) return;

    PhyArch.log(`Command: ${val}`, "#fff");

    if (val.includes("solar")) {
        PhyArch.spawn('sphere', 1, { color: 0xffff00, size: 4 });
        PhyArch.spawn('sphere', 8, { color: 0x88ccff, size: 0.8 });
    } else if (val.includes("city")) {
        PhyArch.spawn('box', 20, { size: 2.5, color: 0x777777 });
    } else if (val.includes("explode")) {
        PhyArch.spawn('box', 30, { size: 0.5, color: 0xff0055 });
    } else if (PhyArch.py && /[\+\-\*\/\^=]/.test(val)) {
        // Python Math logic
        try {
            const expr = val.replace(/\^/g, '**');
            const res = await PhyArch.py.runPythonAsync(`from sympy import *; print(simplify("${expr}"))`);
            PhyArch.log(`SymPy Result: ${res}`, "#00ff88");
            PhyArch.spawn('torus', 5, { color: 0x00ff88 });
        } catch (e) { PhyArch.log("Math Error", "orange"); }
    } else {
        PhyArch.spawn('icosa', 5, { color: 0x00ffff });
    }

    input.value = "";
    // Pulse Core
    PhyArch.coreMesh.scale.setScalar(1.5);
    setTimeout(() => PhyArch.coreMesh.scale.setScalar(1), 200);
}

// Attach Listeners
document.getElementById('inject-btn').addEventListener('click', processInput);
document.getElementById('physics-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') processInput(); });

document.getElementById('btn-ai').addEventListener('click', () => Factory.export('AI Assistant', 'ai'));
document.getElementById('btn-fixer').addEventListener('click', () => Factory.export('Code Fixer', 'fixer'));
document.getElementById('btn-writer').addEventListener('click', () => Factory.export('Writer', 'writer'));
document.getElementById('btn-search').addEventListener('click', () => Factory.export('Knowledge Engine', 'search'));
document.getElementById('btn-social').addEventListener('click', () => Factory.export('Social Feed', 'social'));

window.addEventListener('resize', () => {
    const vp = document.getElementById('viewport');
    PhyArch.camera.aspect = vp.clientWidth / vp.clientHeight;
    PhyArch.camera.updateProjectionMatrix();
    PhyArch.renderer.setSize(vp.clientWidth, vp.clientHeight);
});

// Boot
PhyArch.log("PhyArch OS v2.2 loading...", "#aaa");
PhyArch.initThree();
PhyArch.initPython();
</script>

</body>
</html>        scene.add(floor);

        const coreGeo = new THREE.IcosahedronGeometry(3.2, 1);
        const coreMat = new THREE.MeshPhongMaterial({ color: 0x00ff88, wireframe: true, emissive: 0x00ff88, emissiveIntensity: 0.3 });
        coreMesh = new THREE.Mesh(coreGeo, coreMat);
        scene.add(coreMesh);

        document.getElementById('indicator-physics').classList.add('active');
        systemLog("Master Physics Engine Online", "#00ff88");

        function animate() {
            requestAnimationFrame(animate);
            for (let i = physicsObjects.length - 1; i >= 0; i--) {
                const o = physicsObjects[i];
                o.velocity.y += GRAVITY;
                o.mesh.position.add(o.velocity);
                if (o.mesh.position.y < o.size * 0.6) {
                    o.mesh.position.y = o.size * 0.6;
                    o.velocity.y *= -0.82;
                    o.velocity.x *= 0.95;
                    o.velocity.z *= 0.95;
                }
                o.mesh.rotation.x += 0.02;
                o.mesh.rotation.y += 0.03;
            }
            if(coreMesh) coreMesh.rotation.y += 0.005;
            renderer.render(scene, camera);
        }
        animate();
    }

    function spawn(type = 'box', size = 1.5, color = 0xffffff, vx = 0, vy = 1.2, vz = 0, count = 1) {
        for (let i = 0; i < count; i++) {
            let geo;
            if (type === 'sphere') geo = new THREE.SphereGeometry(size, 32, 32);
            else if (type === 'torus') geo = new THREE.TorusGeometry(size, size * 0.35, 24, 64);
            else if (type === 'icosa') geo = new THREE.IcosahedronGeometry(size, 1);
            else geo = new THREE.BoxGeometry(size, size, size);

            const mat = new THREE.MeshPhongMaterial({ color: color || Math.random() * 0xffffff | 0, wireframe: true });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set((Math.random() - 0.5) * 12, 12 + Math.random() * 8, (Math.random() - 0.5) * 12);
            scene.add(mesh);

            physicsObjects.push({ mesh: mesh, velocity: new THREE.Vector3(vx + (Math.random() - 0.5) * 0.6, vy, vz + (Math.random() - 0.5) * 0.6), size: size });
        }
        systemLog(`Spawned ${count}√ó ${type}(s)`, "#00ff88");
    }

    /* =====================================================================
       3. PYODIDE ENGINE
    ===================================================================== */
    let pyodideInstance;
    async function initPython() {
        systemLog("Booting SymPy Arithmetic...", "yellow");
        try {
            pyodideInstance = await loadPyodide();
            await pyodideInstance.loadPackage("micropip");
            const mp = pyodideInstance.pyimport("micropip");
            await mp.install('sympy');
            await mp.install('numpy');
            document.getElementById('indicator-py').classList.add('active');
            systemLog("SymPy + NumPy Linked", "#00ff88");
        } catch(e) { systemLog("Pyodide Error: " + e.message, "red"); }
    }

    /* =====================================================================
       4. MASTER BUILDER TEMPLATES
    ===================================================================== */
    const MasterCreator = {
        researcher: `
            const searchWiki = async (q) => {
                const res = await fetch('https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=' + encodeURIComponent(q) + '&format=json&origin=*');
                const data = await res.json();
                document.getElementById('results').innerHTML = data.query.search.map(s => 
                    '<div style="padding:12px;border-bottom:1px solid #222"><b>' + s.title + '</b><br><small>' + s.snippet + '</small></div>'
                ).join('');
            };
            document.body.innerHTML = '<div style="background:#050507;color:#0f0;padding:30px;height:100vh;font-family:monospace"><h1>üåê Knowledge Architect</h1><input id="q" placeholder="Ask the universe..." style="width:100%;padding:15px;background:#111;border:1px solid #0f0;color:#0f0;font-size:16px;"><button onclick="searchWiki(document.getElementById(\\'q\\').value)" style="margin-top:15px;padding:15px 30px;background:#0f0;color:#000;border:none;font-weight:bold;">SEARCH</button><div id="results" style="margin-top:25px;max-height:65vh;overflow:auto;"></div></div>';
        `,
        writer: `
            document.body.innerHTML = '<div style="background:#050507;color:#0f0;height:100vh;padding:30px;display:flex;flex-direction:column;font-family:monospace"><h1 contenteditable="true">Sovereign Manuscript</h1><div id="editor" contenteditable="true" style="flex:1;background:#111;border:1px solid #0f0;padding:25px;font-size:16px;line-height:1.7;outline:none;margin-top:20px;">Write the future here...</div></div>';
        `,
        map: `
            const link = document.createElement('link'); link.rel='stylesheet'; link.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'; document.head.appendChild(link);
            const scr = document.createElement('script'); scr.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
            scr.onload = () => { document.body.innerHTML = '<div id="map" style="height:100vh;"></div>'; const m = L.map('map').setView([51.505, -0.09], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m); };
            document.head.appendChild(scr);
        `,
        ai: `
            function send() {
                const q = document.getElementById('q').value;
                if(!q) return;
                document.getElementById('chat').innerHTML += '<div style="color:#0ff;margin:10px 0;">You: ' + q + '</div>';
                document.getElementById('q').value = '';
                setTimeout(() => {
                    document.getElementById('chat').innerHTML += '<div style="color:#0f0;margin:10px 0;">AI: ' + q.toUpperCase() + ' - Reality constructed.</div>';
                }, 700);
            }
            document.body.innerHTML = '<div style="background:#050507;color:#0f0;height:100vh;display:flex;flex-direction:column;padding:25px;font-family:monospace"><h1>üß† Master AI Builder</h1><div id="chat" style="flex:1;background:#111;border:1px solid #0f0;padding:20px;overflow:auto;margin:15px 0;font-size:15px;"></div><div style="display:flex;"><input id="q" style="flex:1;padding:15px;background:#222;border:1px solid #0f0;color:#0f0;"><button onclick="send()" style="margin-left:10px;padding:15px;background:#0f0;color:#000;font-weight:bold;">BUILD</button></div></div>';
        `,
        fixer: `
            document.body.innerHTML = '<div style="background:#050507;color:#ff8800;height:100vh;padding:30px;font-family:monospace;display:flex;flex-direction:column"><h1>üîß Architect Fixer</h1><textarea id="code" style="flex:1;background:#111;border:2px solid #ff8800;color:#ff8800;padding:20px;"></textarea><button onclick="alert(\\'Rebuilt perfectly.\\')" style="margin-top:15px;padding:18px;background:#ff8800;color:#000;font-weight:bold;">FIX CODE</button></div>';
        `,
        social: `
            document.body.innerHTML = '<div style="background:#050507;color:#0088ff;height:100vh;padding:30px;font-family:monospace"><h1>üåê Social Pulse</h1><div style="background:#111;padding:20px;border:1px solid #0088ff;"><b>@masterbuilder</b><br>Just birthed a universe.</div></div>';
        `
    };

    function exportInvention(name, logic) {
        systemLog("Synthesizing " + name + "...", "yellow");
        
        // Carefully splitting script tags to avoid breaking the master document
        const content = '<!DOCTYPE html><html><head><title>' + name + '</title></head><body>' +
            '<script>' + logic + '<\\/script>'.replace('\\/', '/') +
            '</body></html>';

        const blob = new Blob([content], { type: 'text/html' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = name.replace(/ /g, '_') + ".html";
        link.click();
        systemLog(name + " birthed successfully ‚úì", "#00ff88");
    }

    /* =====================================================================
       5. LOGIC CONTROLLER
    ===================================================================== */
    async function executeLogic() {
        const inputField = document.getElementById('physics-input');
        const input = inputField.value.trim();
        if (!input) return;
        
        const lower = input.toLowerCase();
        systemLog("Processing: " + input, "#fff");

        // 3D Scene Generation
        if (lower.includes("build") || lower.includes("create") || lower.includes("spawn")) {
            if (lower.includes("solar")) { spawn('sphere', 4, 0xffff00); spawn('sphere', 1, 0x88ccff, 0,0,0, 8); } 
            else if (lower.includes("city")) spawn('box', 2.5, 0x888888, 0,0,0, 25);
            else spawn('icosa', 2, 0x00ffff, 0, 1.5, 0, 8);
        }
        else if (lower.includes("explode")) spawn('box', 0.9, 0xff0088, 0, 2, 0, 30);
        
        // Math -> Geometry via Pyodide
        else if (pyodideInstance && /[\+\-\*\/\^=]/.test(lower)) {
            try {
                let expr = input.replace(/\\^/g, '**');
                const res = await pyodideInstance.runPythonAsync('from sympy import *\\nprint(simplify(' + expr + '))');
                systemLog(`Math: ${res} -> Geometry`, "#00ff88");
                spawn('box', 1.2, 0x00ff88, 0, 1.5, 0, 5);
            } catch(e) { systemLog("Math error.", "orange"); }
        }
        
        // App Generation Commands
        else if (lower.includes("search") || lower.includes("wiki")) exportInvention("Knowledge", MasterCreator.researcher);
        else if (lower.includes("write") || lower.includes("note")) exportInvention("Writer", MasterCreator.writer);
        else if (lower.includes("map")) exportInvention("Map", MasterCreator.map);
        else if (lower.includes("ai")) exportInvention("AI Terminal", MasterCreator.ai);
        else if (lower.includes("fix")) exportInvention("Fixer", MasterCreator.fixer);
        else if (lower.includes("social")) exportInvention("Social Pulse", MasterCreator.social);
        
        // Default
        else spawn('sphere', 1.6, 0x00ffcc, 0, 1.8, 0, 3);

        if (coreMesh) {
            coreMesh.scale.setScalar(1.6);
            setTimeout(() => { if (coreMesh) coreMesh.scale.setScalar(1); }, 280);
        }
        inputField.value = "";
    }

    window.quickInvent = function(name, type) {
        document.getElementById('physics-input').value = `create ${name} with AI`;
        executeLogic();
        if(type && MasterCreator[type]) exportInvention(name, MasterCreator[type]);
    };

    window.addEventListener('resize', () => {
        if (camera && renderer) {
            const vp = document.getElementById('viewport');
            camera.aspect = vp.clientWidth / vp.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(vp.clientWidth, vp.clientHeight);
        }
    });

    document.getElementById('physics-input').addEventListener('keypress', e => { if (e.key === 'Enter') executeLogic(); });

    /* =====================================================================
       6. SYSTEM BOOT
    ===================================================================== */
    initThree();
    initPython();

</script>
</body>
</html>        systemLog("Master Physics Engine + AI Geometry Mapper Online", "#00ff88");

        function animate() {
            requestAnimationFrame(animate);

            // Physics update
            for (let i = physicsObjects.length - 1; i >= 0; i--) {
                const o = physicsObjects[i];
                o.velocity.y += GRAVITY;
                o.mesh.position.add(o.velocity);

                if (o.mesh.position.y < o.size * 0.6) {
                    o.mesh.position.y = o.size * 0.6;
                    o.velocity.y *= -0.82;
                    o.velocity.x *= 0.95;
                    o.velocity.z *= 0.95;
                }
                o.mesh.rotation.x += 0.02;
                o.mesh.rotation.y += 0.03;
            }

            coreMesh.rotation.y += 0.005;
            renderer.render(scene, camera);
        }
        animate();
    }

    function spawn(type = 'box', size = 1.5, color = 0xffffff, vx = 0, vy = 1.2, vz = 0, count = 1) {
        for (let i = 0; i < count; i++) {
            let geo;
            if (type === 'sphere') geo = new THREE.SphereGeometry(size, 32, 32);
            else if (type === 'torus') geo = new THREE.TorusGeometry(size, size * 0.35, 24, 64);
            else if (type === 'icosa') geo = new THREE.IcosahedronGeometry(size, 1);
            else geo = new THREE.BoxGeometry(size, size, size);

            const mat = new THREE.MeshPhongMaterial({ color: color || Math.random() * 0xffffff | 0, wireframe: true });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set((Math.random() - 0.5) * 12, 12 + Math.random() * 8, (Math.random() - 0.5) * 12);
            scene.add(mesh);

            physicsObjects.push({
                mesh: mesh,
                velocity: new THREE.Vector3(vx + (Math.random() - 0.5) * 0.6, vy, vz + (Math.random() - 0.5) * 0.6),
                size: size
            });
        }
        systemLog(`Master AI spawned ${count}√ó ${type}(s)`, "#00ff88");
    }

    // ====================== PYODIDE ======================
    let pyodideInstance;
    async function initPython() {
        systemLog("Booting SymPy Arithmetic ‚Üí Geometry Engine...", "yellow");
        try {
            pyodideInstance = await loadPyodide();
            await pyodideInstance.loadPackage("micropip");
            const mp = pyodideInstance.pyimport("micropip");
            await mp.install('sympy');
            await mp.install('numpy');
            document.getElementById('indicator-py').classList.add('active');
            systemLog("SymPy + NumPy Linked to 3D MasterBuilder", "#00ff88");
        } catch(e) { systemLog("Pyodide: " + e.message, "red"); }
    }

    // ====================== FULL MASTER CREATOR AI INVENTIONS ======================
    const MasterCreator = {
        researcher: `
            const searchWiki = async (q) => {
                const res = await fetch('https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=' + encodeURIComponent(q) + '&format=json&origin=*');
                const data = await res.json();
                document.getElementById('results').innerHTML = data.query.search.map(s => 
                    '<div style="padding:12px;border-bottom:1px solid #222"><b>' + s.title + '</b><br><small>' + s.snippet + '</small></div>'
                ).join('');
            };
            document.body.innerHTML = \`
                <div style="background:#050507;color:#0f0;padding:30px;height:100vh;font-family:monospace">
                    <h1>üåê Knowledge Architect</h1>
                    <input id="q" placeholder="Ask the universe..." style="width:100%;padding:15px;background:#111;border:1px solid #0f0;color:#0f0;font-size:16px;">
                    <button onclick="searchWiki(document.getElementById('q').value)" style="margin-top:15px;padding:15px 30px;background:#0f0;color:#000;border:none;font-weight:bold;">SEARCH KNOWLEDGE</button>
                    <div id="results" style="margin-top:25px;max-height:65vh;overflow:auto;"></div>
                </div>
            \`;
        `,

        writer: `
            document.body.innerHTML = \`
                <div style="background:#050507;color:#0f0;height:100vh;padding:30px;display:flex;flex-direction:column;font-family:monospace">
                    <h1 contenteditable="true">Sovereign Manuscript</h1>
                    <div id="editor" contenteditable="true" style="flex:1;background:#111;border:1px solid #0f0;padding:25px;font-size:16px;line-height:1.7;outline:none;margin-top:20px;">Write the future here...</div>
                </div>
            \`;
        `,

        map: `
            const link = document.createElement('link'); link.rel='stylesheet'; link.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'; document.head.appendChild(link);
            const scr = document.createElement('script'); scr.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
            scr.onload = () => {
                document.body.innerHTML = '<div id="map" style="height:100vh;"></div>';
                const m = L.map('map').setView([51.505, -0.09], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
            };
            document.head.appendChild(scr);
        `,

        ai: `
            let history = [];
            function send() {
                const q = document.getElementById('q').value.trim();
                if (!q) return;
                history.push({role:'user', content:q});
                document.getElementById('chat').innerHTML += '<div style="color:#0ff;margin:10px 0;">You: ' + q + '</div>';
                document.getElementById('q').value = '';
                document.getElementById('chat').scrollTop = 999999;
                setTimeout(() => {
                    const reply = "Master AI Builder: " + q.toUpperCase().replace(/ /g, " ‚ú® ") + " ‚Äî Reality constructed. What shall we build next?";
                    history.push({role:'assistant', content:reply});
                    document.getElementById('chat').innerHTML += '<div style="color:#0f0;margin:10px 0;">' + reply + '</div>';
                    document.getElementById('chat').scrollTop = 999999;
                }, 700);
            }
            document.body.innerHTML = \`
                <div style="background:#050507;color:#0f0;height:100vh;display:flex;flex-direction:column;padding:25px;font-family:monospace">
                    <h1>üß† Master AI Builder Terminal</h1>
                    <div id="chat" style="flex:1;background:#111;border:1px solid #0f0;padding:20px;overflow:auto;margin:15px 0;font-size:15px;"></div>
                    <div style="display:flex;">
                        <input id="q" placeholder="Tell the Master AI what to build..." style="flex:1;padding:15px;background:#222;border:1px solid #0f0;color:#0f0;">
                        <button onclick="send()" style="margin-left:10px;padding:15px 40px;background:#0f0;color:#000;border:none;font-weight:bold;">BUILD</button>
                    </div>
                </div>
            \`;
        `,

        fixer: `
            document.body.innerHTML = \`
                <div style="background:#050507;color:#ff8800;height:100vh;padding:30px;font-family:monospace;display:flex;flex-direction:column">
                    <h1>üîß Master Architect Fixer</h1>
                    <textarea id="code" style="flex:1;background:#111;border:2px solid #ff8800;color:#ff8800;padding:20px;font-family:monospace;resize:none;">// Paste any broken invention here...</textarea>
                    <button onclick="alert('Master AI has fixed your code and rebuilt it perfectly. (Full LLM version would return corrected file)')" style="margin-top:15px;padding:18px;background:#ff8800;color:#000;border:none;font-weight:bold;width:100%;">FIX + REBUILD INVENTION</button>
                </div>
            \`;
        `,

        social: `
            document.body.innerHTML = \`
                <div style="background:#050507;color:#0088ff;height:100vh;padding:30px;font-family:monospace">
                    <h1>üåê Social Pulse Network</h1>
                    <div style="background:#111;padding:20px;border:1px solid #0088ff;margin-bottom:15px;">
                        <b>@masterbuilder</b> ¬∑ now<br>Just birthed a new universe with PhyArch AI.
                    </div>
                    <div style="background:#111;padding:20px;border:1px solid #0088ff;margin-bottom:15px;">
                        <b>@phyarch</b> ¬∑ 42s ago<br>The simulation is becoming the simulator.
                    </div>
                </div>
            \`;
        `
    };

    function exportInvention(name, logic) {
        systemLog("Master AI synthesizing " + name + "...", "yellow");
        let injected = '';
        if (logic.includes('leaflet')) injected = '<scr' + 'ipt src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></scr' + 'ipt>';

        const content = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>${name} ‚Äî PhyArch Master Invention</title>
    ${injected}
    <style>body{background:#050507;color:#0f0;font-family:monospace;margin:0;overflow:hidden;} .glass{background:rgba(10,30,10,0.95);border:2px solid #0f0;margin:50px;padding:40px;border-radius:12px;}</style>
</head>
<body>
    <div class="glass">
        <h1>${name}</h1>
        <hr style="border-color:#222;margin:20px 0;">
        <div id="app-root"></div>
    </div>
    <script>${logic}</script>
</body>
</html>`;

        const blob = new Blob([content], { type: 'text/html' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = name.replace(/ /g, '_') + ".html";
        link.click();
        systemLog(name + " successfully birthed by Master AI ‚úì", "#00ff88");
    }

    // ====================== MASTER AI BUILDER CORE ======================
    async function executeLogic() {
        let input = document.getElementById('physics-input').value.trim();
        if (!input) return;
        const lower = input.toLowerCase();

        systemLog("Master AI Builder processing: " + input, "#fff");

        // MASTER BUILDER NATURAL LANGUAGE AI
        if (lower.includes("build") || lower.includes("create") || lower.includes("make") || lower.includes("spawn") || lower.includes("solar") || lower.includes("city") || lower.includes("orbit")) {
            systemLog("üõ†Ô∏è MASTER AI SYNTHESIZING SCENE...", "#00ff88");
            if (lower.includes("solar")) {
                spawn('sphere', 4, 0xffff00, 0, 0, 0, 1); // sun
                for (let i = 0; i < 8; i++) spawn('sphere', 0.8 + Math.random() * 1.2, 0x88ccff, 0, 0, 0, 1);
            } else if (lower.includes("city")) {
                spawn('box', 2.5, 0x888888, 0, 0, 0, 25);
            } else if (lower.includes("orbit")) {
                spawn('torus', 1.8, 0xff00ff, 0, 0.8, 0, 12);
            } else {
                spawn('icosa', 2, 0x00ffff, 0, 1.5, 0, 8);
            }
        }
        else if (lower.includes("drop") || lower.includes("fall")) {
            spawn('sphere', 2.2, 0xff8800, 0, 2, 0, 5);
        }
        else if (lower.includes("explode")) {
            spawn('box', 0.9, 0xff0088, 0, 2, 0, 30);
        }
        // MATH ‚Üí GEOMETRY
        else if (pyodideInstance && /[\+\-\*\/\^=]/.test(lower)) {
            try {
                let expr = input.replace(/\^/g, '**');
                const res = await pyodideInstance.runPythonAsync(`from sympy import *\nprint(simplify(${expr}))`);
                systemLog(`SymPy ‚Üí ${res} | Mapping to geometry...`, "#00ff88");
                let val = Math.abs(parseFloat(res)) || 5;
                spawn('box', 1.2, 0x00ff88, 0, 1.5, 0, Math.min(Math.floor(val), 15));
            } catch(e) {
                systemLog("Math ‚Üí Geometry mapping failed", "orange");
            }
        }
        // INVENTION COMMANDS
        else if (lower.includes("search") || lower.includes("wiki")) {
            exportInvention("Knowledge Architect", MasterCreator.researcher);
        } else if (lower.includes("write") || lower.includes("note")) {
            exportInvention("Sovereign Writer", MasterCreator.writer);
        } else if (lower.includes("map") || lower.includes("atlas")) {
            exportInvention("Global Map", MasterCreator.map);
        } else if (lower.includes("ai") || lower.includes("chat")) {
            exportInvention("Master AI Terminal", MasterCreator.ai);
        } else if (lower.includes("fix") || lower.includes("architect")) {
            exportInvention("Code Fixer Architect", MasterCreator.fixer);
        } else if (lower.includes("social")) {
            exportInvention("Social Pulse", MasterCreator.social);
        }
        else {
            systemLog("Master AI interpreting as freeform prompt...", "#aaa");
            spawn('sphere', 1.6, 0x00ffcc, 0, 1.8, 0, 6);
        }

        // Core visual pulse
        if (coreMesh) {
            coreMesh.scale.setScalar(1.6);
            setTimeout(() => { if (coreMesh) coreMesh.scale.setScalar(1); }, 280);
        }

        document.getElementById('physics-input').value = "";
    }

    window.quickInvent = function(name, type) {
        document.getElementById('physics-input').value = `create ${name} with Master AI`;
        executeLogic();
        spawn('icosa', 1.4, 0x00ffff); // birth visual
    };

    // Resize
    window.addEventListener('resize', () => {
        if (camera && renderer) {
            camera.aspect = document.getElementById('viewport').clientWidth / document.getElementById('viewport').clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(document.getElementById('viewport').clientWidth, document.getElementById('viewport').clientHeight);
        }
    });

    // Enter key
    document.getElementById('physics-input').addEventListener('keypress', e => { if (e.key === 'Enter') executeLogic(); });

    // ====================== FINAL BOOT ======================
    systemLog("PhyArch MasterBuilder AI v2.1 ‚Äî Reality is now editable", "#00ff88");
    initThree();
    initPython();
</script>
</body>
</html>            renderer.render(scene, camera);
        }
        animate();

        /* ==========================================
           PYODIDE
        ========================================== */
        let pyodideInstance;
        async function initPythonEngine() {
            systemLog("Booting Pyodide Engine...", "yellow");
            try {
                pyodideInstance = await loadPyodide();
                await pyodideInstance.loadPackage("micropip");
                const micropip = pyodideInstance.pyimport("micropip");
                await micropip.install('sympy');
                await micropip.install('numpy');
                document.getElementById('indicator-py').classList.add('active');
                systemLog("Python Engine Active.", "#00ff88");
            } catch (err) {
                systemLog("Engine Boot Failed: " + err, "red");
            }
        }
        initPythonEngine();

        /* ==========================================
           EXECUTION
        ========================================== */
        async function executeLogic() {
            const input = document.getElementById('physics-input').value.trim();
            if (!input) return;

            if (input.startsWith("auth ")) {
                window.githubToken = input.split(" ")[1];
                systemLog("Factory Access Granted.", "#00ff88");
                document.getElementById('physics-input').value = "";
                return;
            }

            const cmd = input.toLowerCase();

            if (cmd.includes("search") || cmd.includes("find")) {
                MasterCreator.exportInvention("Searcher", MasterCreator.researcher);
                systemLog("Opening Search Engine...", "#00ff88");
            } else if (cmd.includes("map") || cmd.includes("where")) {
                MasterCreator.exportInvention("Atlas", MasterCreator.map);
                systemLog("Opening Global Map...", "#00ff88");
            } else if (cmd.includes("write") || cmd.includes("note")) {
                MasterCreator.exportInvention("Notepad", MasterCreator.writer);
                systemLog("Opening Writing Pad...", "#00ff88");
            } else if (cmd.includes("data") || cmd.includes("stat")) {
                MasterCreator.exportInvention("DataAnalyzer", MasterCreator.researcher + "\n// math. db.");
                systemLog("Fetching Statistical Nodes...", "blue");
            } else {
                systemLog(`Processing: ${input}`, "#fff");
            }

            document.getElementById('physics-input').value = "";

            coreMesh.scale.set(
                Math.random() * 1.5 + 0.5,
                Math.random() * 1.5 + 0.5,
                Math.random() * 1.5 + 0.5
            );
        }

        /* ==========================================
           LIBRARIES (VITE-SAFE)
        ========================================== */
        const LIBS = {
            THREE: 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js',
            MAP: 'https://unpkg.com/leaflet/dist/leaflet.js',
            MATH: 'https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.min.js',
            DEXIE: 'https://unpkg.com/dexie/dist/dexie.js',
        };

        // ULTRA-SAFE version ‚Äî no <script> substring anywhere in source
        const getLib = (name) => '&lt;script src="' + LIBS[name] + '"&gt;&lt;/script&gt;';

        /* ==========================================
           MASTER CREATOR
        ========================================== */
        const MasterCreator = {
            researcher: `
                const searchWiki = async (query) => {
                    const response = await fetch('https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=' + query + '&format=json&origin=*');
                    const data = await response.json();
                    document.getElementById('results').innerHTML = data.query.search
                        .map(s => '<div><b>' + s.title + '</b><br>' + s.snippet + '</div>')
                        .join('');
                };
                document.body.innerHTML = \`
                    <div class="glass-card">
                        <input id="q" placeholder="Search Knowledge Base..." style="width:100%;padding:10px;">
                        <button onclick="searchWiki(document.getElementById('q').value)">Search</button>
                        <div id="results" style="max-height:300px; overflow-y:auto; margin-top:10px;"></div>
                    </div>
                \`;
            `,

            writer: `
                document.body.innerHTML = \`
                    <div class="glass-card" style="height:90vh;display:flex;flex-direction:column;">
                        <h2 contenteditable="true">Untitled Document</h2>
                        <div id="editor" contenteditable="true" style="flex-grow:1;outline:none;padding:20px;"></div>
                    </div>
                \`;
            `,

            map: `
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://unpkg.com/leaflet/dist/leaflet.css';
                document.head.appendChild(link);
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet/dist/leaflet.js';
                script.onload = () => {
                    document.body.innerHTML = '<div id="map" style="height:100vh;"></div>';
                    const m = L.map('map').setView([51.505, -0.09], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
                };
                document.head.appendChild(script);
            `,

            inventApp: function(name, type) {
                systemLog(\`Synthesizing Native \${type}: \${name}...\`, "yellow");
            },

            exportInvention: function(name, logic) {
                let injectedLibs = '';
                if (logic.includes('THREE')) injectedLibs += getLib('THREE');
                if (logic.includes('L.map')) injectedLibs += getLib('MAP');
                if (logic.includes('math.')) injectedLibs += getLib('MATH');
                if (logic.includes('db.')) injectedLibs += getLib('DEXIE');

                const content = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>' + name + ' - Generated by PhyArch</title>' +
                    injectedLibs +
                    '<style>body{background:#050507;color:#00ff88;font-family:monospace;margin:0;overflow:hidden;}#status-node{position:fixed;top:0;width:100%;background:rgba(0,20,10,0.95);border-bottom:1px solid #00ff88;padding:8px;font-size:11px;z-index:10000;display:flex;justify-content:space-between;}.glass-card{background:rgba(20,25,20,0.9);border:1px solid #00ff88;margin:60px 20px;padding:20px;border-radius:8px;}</style></head>' +
                    '<body><div id="status-node"><span>SYSTEM: SIMULATION READY</span><span id="boot-status">Waking Engines...</span></div>' +
                    '<div class="glass-card"><h1>' + name + '</h1><hr style="border-color:#333"><div id="app-root"></div></div>' +
                    '<script>window.onload = () => { const time = (performance.now()/1000).toFixed(2); document.getElementById("boot-status").innerText = time + "s Boot"; };</script>' +
                    '<script>' + logic + '</script></body></html>';

                const blob = new Blob([content], { type: 'text/html' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = name + ".html";
                link.click();
                systemLog("Invention " + name + " birthed successfully.", "#00ff88");
    }
};

        /* ==========================================
           UTILITIES
        ========================================== */
        window.addEventListener('resize', () => {
            camera.aspect = viewport.clientWidth / viewport.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(viewport.clientWidth, viewport.clientHeight);
        });

        window.quickInvent = function(name, type) {
            const input = document.getElementById('physics-input');
            if (input) {
                input.value = `invent ${name} ${type}`;
                executeLogic();
            }
        };

        systemLog("PhyArch Builder v1.0 ready.", "#00ff88");

        /* ==========================================
           PYODIDE ENGINE
        ========================================== */
        let pyodideInstance;

        async function initPythonEngine() {
            systemLog("Booting Pyodide Engine...", "yellow");
            try {
                pyodideInstance = await loadPyodide();
                await pyodideInstance.loadPackage("micropip");
                const micropip = pyodideInstance.pyimport("micropip");
                await micropip.install('sympy');
                await micropip.install('numpy');

                document.getElementById('indicator-py').classList.add('active');
                systemLog("Python Engine Active.", "#00ff88");
            } catch (err) {
                systemLog("Engine Boot Failed: " + err, "red");
            }
        }
        initPythonEngine();

        /* ==========================================
           EXECUTION BRIDGE
        ========================================== */
        async function executeLogic() {
            const input = document.getElementById('physics-input').value.trim();
            if (!input) return;

            // Authentication
            if (input.startsWith("auth ")) {
                window.githubToken = input.split(" ")[1];
                systemLog("Factory Access Granted.", "#00ff88");
                document.getElementById('physics-input').value = "";
                return;
            }

            // Inventions
            const cmd = input.toLowerCase();

            if (cmd.includes("search") || cmd.includes("find")) {
                MasterCreator.exportInvention("Searcher", MasterCreator.researcher);
                systemLog("Opening Search Engine...", "#00ff88");
                document.getElementById('physics-input').value = "";
                return;
            }
            if (cmd.includes("map") || cmd.includes("where")) {
                MasterCreator.exportInvention("Atlas", MasterCreator.map);
                systemLog("Opening Global Map...", "#00ff88");
                document.getElementById('physics-input').value = "";
                return;
            }
            if (cmd.includes("write") || cmd.includes("note")) {
                MasterCreator.exportInvention("Notepad", MasterCreator.writer);
                systemLog("Opening Writing Pad...", "#00ff88");
                document.getElementById('physics-input').value = "";
                return;
            }
            if (cmd.includes("data") || cmd.includes("stat")) {
                MasterCreator.exportInvention("DataAnalyzer", MasterCreator.researcher + "\n// math. db.");
                systemLog("Fetching Statistical Nodes...", "blue");
                document.getElementById('physics-input').value = "";
                return;
            }

            systemLog(`Processing: ${input}`, "#fff");
            document.getElementById('physics-input').value = "";

            // Visual feedback
            coreMesh.scale.set(
                Math.random() * 1.5 + 0.5,
                Math.random() * 1.5 + 0.5,
                Math.random() * 1.5 + 0.5
            );
        }

/* ==========================================
   LIBRARY REPOSITORY (Vite-safe)
========================================== */
const LIBS = {
    THREE: 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js',
    MAP: 'https://unpkg.com/leaflet/dist/leaflet.js',
    MATH: 'https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.min.js',
    DEXIE: 'https://unpkg.com/dexie/dist/dexie.js'
};

const getLib = (name) => {
    const s = document.createElement('script');
    s.src = LIBS[name];
    s.async = false; 
    document.head.appendChild(s);
    return ""; 
};

        /* ==========================================
           MASTER CREATOR (AUTO-INVENT)
        ========================================== */
        const MasterCreator = {
            researcher: `
                const searchWiki = async (query) => {
                    const response = await fetch('https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=' + query + '&format=json&origin=*');
                    const data = await response.json();
                    document.getElementById('results').innerHTML = data.query.search
                        .map(s => '<div><b>' + s.title + '</b><br>' + s.snippet + '</div>')
                        .join('');
                };
                document.body.innerHTML = \`
                    <div class="glass-card">
                        <input id="q" placeholder="Search Knowledge Base..." style="width:100%;padding:10px;">
                        <button onclick="searchWiki(document.getElementById('q').value)">Search</button>
                        <div id="results" style="max-height:300px; overflow-y:auto; margin-top:10px;"></div>
                    </div>
                \`;
            `,

            writer: `
                document.body.innerHTML = \`
                    <div class="glass-card" style="height:90vh;display:flex;flex-direction:column;">
                        <h2 contenteditable="true">Untitled Document</h2>
                        <div id="editor" contenteditable="true" style="flex-grow:1;outline:none;padding:20px;"></div>
                    </div>
                \`;
            `,

            map: `
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://unpkg.com/leaflet/dist/leaflet.css';
                document.head.appendChild(link);

                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet/dist/leaflet.js';
                script.onload = () => {
                    document.body.innerHTML = '<div id="map" style="height:100vh;"></div>';
                    const m = L.map('map').setView([51.505, -0.09], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
                };
                document.head.appendChild(script);
            `,

            inventApp: function(name, type) {
                systemLog(\`Synthesizing Native \${type}: \${name}...\`, "yellow");
            },

            exportInvention: function(name, logic) {
                let injectedLibs = '';
                if (logic.includes('THREE')) injectedLibs += getLib('THREE');
                if (logic.includes('L.map')) injectedLibs += getLib('MAP');
                if (logic.includes('math.')) injectedLibs += getLib('MATH');
                if (logic.includes('db.')) injectedLibs += getLib('DEXIE');

                const content = '<!DOCTYPE html>' +
                    '<html lang="en">' +
                    '<head>' +
                        '<meta charset="UTF-8">' +
                        '<title>' + name + ' - Generated by PhyArch</title>' +
                        injectedLibs +
                        '<style>' +
                            'body { background:#050507; color:#00ff88; font-family:monospace; margin:0; overflow:hidden; }' +
                            '#status-node { position:fixed; top:0; width:100%; background:rgba(0,20,10,0.95); border-bottom:1px solid #00ff88; padding:8px; font-size:11px; z-index:10000; display:flex; justify-content:space-between; }' +
                            '.glass-card { background:rgba(20,25,20,0.9); border:1px solid #00ff88; margin:60px 20px; padding:20px; border-radius:8px; }' +
                        '</style>' +
                    '</head>' +
                    '<body>' +
                        '<div id="status-node">' +
                            '<span>SYSTEM: SIMULATION READY</span>' +
                            '<span id="boot-status">Waking Engines...</span>' +
                        '</div>' +
                        '<div class="glass-card">' +
                            '<h1>' + name + '</h1>' +
                            '<hr style="border-color:#333">' +
                            '<div id="app-root"></div>' +
                        '</div>' +
                        '<script>window.onload = () => { const time = (performance.now()/1000).toFixed(2); document.getElementById("boot-status").innerText = time + "s Boot"; };</script>' +
                        '<script>' + logic + '</script>' +
                    '</body>' +
                    '</html>';

                const blob = new Blob([content], { type: 'text/html' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = name + ".html";
                link.click();
                systemLog("Invention " + name + " birthed successfully.", "#00ff88");
            }
        };

        /* ==========================================
           WINDOW UTILITIES
        ========================================== */
        window.addEventListener('resize', () => {
            camera.aspect = viewport.clientWidth / viewport.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(viewport.clientWidth, viewport.clientHeight);
        });

        window.quickInvent = function(name, type) {
            const input = document.getElementById('physics-input');
            if (input) {
                input.value = `invent ${name} ${type}`;
                executeLogic();
            }
        };

        // Final ready message
        systemLog("PhyArch Builder v1.0 ready. Type a command or press a button.", "#00ff88");
    </script>
</body>
</html>        renderer.setSize(viewport.clientWidth, viewport.clientHeight);
        viewport.appendChild(renderer.domElement);

        // Core visual object (Placeholder for physics manipulation)
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshBasicMaterial({ color: 0x00ff88, wireframe: true });
        const coreMesh = new THREE.Mesh(geometry, material);
        scene.add(coreMesh);

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        /* ==========================================
           MODULE 3: PYTHON (PYODIDE) ENGINE
        ========================================== */
        let pyodideInstance;
        
        async function initPythonEngine() {
            systemLog("Booting Pyodide Engine...", "yellow");
            try {
                pyodideInstance = await loadPyodide();
                await pyodideInstance.loadPackage("micropip");
                const micropip = pyodideInstance.pyimport("micropip");
                
                systemLog("Installing SymPy & NumPy (Local Sandbox)...", "yellow");
                await micropip.install('sympy');
                await micropip.install('numpy');
                
                document.getElementById('indicator-py').classList.add('active');
                systemLog("Python Engine Active. Ready for complex logic.", "#00ff88");
            } catch (err) {
                systemLog("Engine Boot Failed: " + err, "red");
            }
        }
        
        // Start engine in background
        initPythonEngine();
        /* =============================================
   MODULE 4: EXECUTION BRIDGE (MASTER)
================================================ */
async function executeLogic() {
    const input = document.getElementById('physics-input').value;
    if(!input) return;

    // 1. Handle Authentication
    if (input.startsWith("auth ")) {
        const token = input.split(" ")[1];
        window.githubToken = token;
        systemLog("Factory Access Granted. Hands are active.", "#00ff88");
        document.getElementById('physics-input').value = "";
        return;
    }

    // 2. Handle Inventions
    let cmd = input.toLowerCase();

    if (cmd.includes("search") || cmd.includes("find")) {
        MasterCreator.exportInvention("Searcher", MasterCreator.researcher);
        systemLog("Opening Search Engine...", "#00ff88");
    } else if (cmd.includes("map") || cmd.includes("where")) {
        MasterCreator.exportInvention("Atlas", MasterCreator.map);
        systemLog("Opening Global Map...", "#00ff88");
    } else if (cmd.includes("write") || cmd.includes("note")) {
        MasterCreator.exportInvention("Notepad", MasterCreator.writer);
        systemLog("Opening Writing Pad...", "#00ff88");
    } else if (cmd.includes("data") || cmd.includes("stat")) {
        MasterCreator.exportInvention("DataAnalyzer", MasterCreator.researcher + "\n // math. db.");
        systemLog("Fetching Statistical Nodes...", "blue");
    }

    systemLog(`Processing: ${input}`, "#fff");
    document.getElementById('physics-input').value = "";

    // Visual feedback trigger
    if(window.coreMesh) {
        coreMesh.scale.set(Math.random()*1.5 + 0.5, Math.random()*1.5 + 0.5, Math.random()*1.5 + 0.5);
    }
}

// Central Library Repository
const LIBS = {
    THREE: 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js',
    MAP: 'https://unpkg.com/leaflet/dist/leaflet.js',
    MATH: 'https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.min.js',
    DEXIE: 'https://unpkg.com/dexie/dist/dexie.js',
};

/** * FIX: Using string concatenation to prevent Vite's HTML parser 
 * from misidentifying this as a real script tag.
 */
const getLib = (name) => '<scr' + 'ipt src="' + LIBS[name] + '"></scr' + 'ipt>';

/* =============================================
   MODULE 6: MASTER CREATOR (AUTO-INVENT)
================================================ */
const MasterCreator = {
    researcher: `
        const searchWiki = async (query) => {
            const const getLib = (name) => '<scr' + 'ipt src="' + LIBS[name] + '"></scr' + 'ipt>';
            const data = await response.json();
            document.getElementById('results').innerHTML = data.query.search.map(s => '<div><b>'+s.title+'</b><br>'+s.snippet+'</div>').join('');
        };
        document.body.innerHTML = \`
            <div class="glass-card">
                <input id="q" placeholder="Search Knowledge Base...">
                <button onclick="searchWiki(document.getElementById('q').value)">Search</button>
                <div id="results" style="max-height:300px; overflow-y:auto;"></div>
            </div>
        \`;
    `,

    writer: `
        document.body.innerHTML = \`
            <div class="glass-card" style="height: 90vh; display: flex; flex-direction: column;">
                <h2 contenteditable="true">Untitled Document</h2>
                <div id="editor" contenteditable="true" style="flex-grow: 1; outline: none; padding: 20px;">
                    Start typing your sovereign thoughts here...
                </div>
            </div>
        \`;
    `,

    inventApp: function(name, type) {
        systemLog(\`Synthesizing Native \${type}: \${name}...\`, "yellow");
        // Logic for native app assembly goes here
    },

exportInvention: function(name, logic) {
        let injectedLibs = '';
        if (logic.includes('THREE')) injectedLibs += getLib('THREE');
        if (logic.includes('L.map')) injectedLibs += getLib('MAP');
        if (logic.includes('math.')) injectedLibs += getLib('MATH');
        if (logic.includes('db.'))   injectedLibs += getLib('DEXIE');

        var content = '<!DOCTYPE html>' +
            '<html>' +
            '<head>' +
            '<meta charset="UTF-8">' +
            '<title>' + name + ' - Generated</title>' +
            injectedLibs +
            '<style>' +
            'body { background:#050507; color:#00ff88; font-family:monospace; margin:0; padding:20px; }' +
            '.glass-card { background:rgba(20,20,25,0.8); border:1px solid #333; padding:20px; border-radius:8px; }' +
            '#status-node { position:fixed; top:0; left:0; width:100%; background:#000; border-bottom:1px solid #00ff88; padding:5px; font-size:10px; display:flex; justify-content:space-between; z-index:1000; }' +
            '</style>' +
            '</head>' +
            '<body>' +
            '<div id="status-node"><span>SYSTEM ACTIVE</span><span id="boot-status">Waking...</span></div>' +
            '<div class="glass-card">' +
            '<h1>' + name + '</h1>' +
            '<hr style="border:0; border-top:1px solid #222;">' +
            '<div id="app-root"></div>' +
            '</div>' +
            '<scr' + 'ipt>' +
            'window.onload = () => {' +
            'const time = (performance.now()/1000).toFixed(2);' +
            'document.getElementById("boot-status").innerText = time + "s Boot";' +
            logic + 
            '};' +
            '</scr' + 'ipt>' +
            '</body>' +
            '</html>';

        const blob = new Blob([content], { type: 'text/html' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = name + ".html";
        link.click();
        systemLog("Invention " + name + " birthed successfully.", "#00ff88");
    }
};

// Handle Resizing
window.addEventListener('resize', () => {
    if(window.camera && window.renderer) {
        camera.aspect = viewport.clientWidth / viewport.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(viewport.clientWidth, viewport.clientHeight);
    }
});

// Quick Invent Logic
window.quickInvent = function(name, type) {
    const input = document.getElementById('physics-input');
    if (input) {
        input.value = \`invent \${name} \${type}\`;
        executeLogic();
    }
};
// ... all your previous logic (Pyodide, MasterCreator, etc.) ...

    function animate() {
        requestAnimationFrame(animate);
        if (window.renderer && window.scene && window.camera) {
            renderer.render(scene, camera);
        }
    }
animate(); // This starts the loop once everything is loaded

</script>
</body>
</html>
