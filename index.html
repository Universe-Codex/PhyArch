<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PhyArch Builder IDE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

    <style>
        :root { --bg: #0a0a0c; --panel: #1a1a20; --text: #e0e0e0; --accent: #00ff88; --border: #333; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Courier New', Courier, monospace; }
        body { background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        header { background: var(--panel); border-bottom: 1px solid var(--border); padding: 10px; display: flex; justify-content: space-between; font-size: 14px; font-weight: bold; z-index: 10; }
        .status-light { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: red; margin-right: 5px; }
        .active { background: var(--accent); box-shadow: 0 0 8px var(--accent); }

        #viewport { flex-grow: 1; position: relative; width: 100%; background: #000; }
        canvas { display: block; width: 100%; height: 100%; }

        #console-panel { background: var(--panel); border-top: 1px solid var(--border); height: 35%; display: flex; flex-direction: column; z-index: 10; }
        #log-output { flex-grow: 1; padding: 10px; overflow-y: auto; font-size: 12px; color: #aaa; border-bottom: 1px solid var(--border); background: #111; }
        .input-area { display: flex; padding: 10px; gap: 10px; }
        input[type="text"] { flex-grow: 1; background: #222; border: 1px solid var(--border); color: var(--accent); padding: 10px; border-radius: 4px; font-size: 14px; outline: none; }
        button { background: #333; color: white; border: 1px solid var(--border); padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        button:active { background: var(--accent); color: black; }
    </style>
</head>
<body>

    <header>
        <div>PhyArch Builder v1.0</div>
        <div>
            <span id="indicator-py" class="status-light"></span> Pyodide
            <span id="indicator-gh" class="status-light" style="margin-left: 10px;"></span> Factory
        </div>
    </header>

    <main id="viewport"></main>

    <section id="console-panel">
        <div id="log-output">
            <div>> System Initializing...</div>
            <div>> Loading WebGL Framework...</div>
        </div>
        <div class="input-area">
            <input type="text" id="physics-input" placeholder="Enter LLM Prompt or Equation (e.g., F = m * a)" autocomplete="off">
            <button onclick="executeLogic()">Inject</button>
        </div>
        <div style="display: flex; gap: 10px; padding: 10px; flex-wrap: wrap; justify-content: center; background: rgba(0,0,0,0.3);">
            <button onclick="quickInvent('AI', 'ai')" style="background:#004422;border:1px solid #00ff88;color:white;">+ AI Bot</button>
            <button onclick="quickInvent('Fixer', 'architect')" style="background:#442200;border:1px solid #ff8800;color:white;">+ Fixer</button>
            <button onclick="quickInvent('Social', 'social')" style="background:#002244;border:1px solid #0088ff;color:white;">+ Social</button>
            <button onclick="quickInvent('Doc', 'writer')" style="background:#440044;border:1px solid #ff00ff;color:white;">+ Writer</button>
            <button onclick="quickInvent('Search', 'researcher')" style="background:#004444;border:1px solid #00ffff;color:white;">+ Search</button>
        </div>
    </section>

    <script type="module">
        /* ==========================================
           UI & LOGGING
        ========================================== */
        const logWindow = document.getElementById('log-output');
        function systemLog(message, color = "#aaa") {
            logWindow.innerHTML += `<div style="color:${color}">> ${message}</div>`;
            logWindow.scrollTop = logWindow.scrollHeight;
        }

        /* ==========================================
           THREE.JS ENGINE
        ========================================== */
        import { Octokit } from "https://esm.sh/@octokit/rest";

        async function deployInvention(name, content) {
            systemLog(`Initiating Factory Build for: ${name}...`, "yellow");
        }

        const viewport = document.getElementById('viewport');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.05);
        scene.add(new THREE.GridHelper(20, 20, 0x444444, 0x222222));
        scene.add(new THREE.AxesHelper(5));

        const camera = new THREE.PerspectiveCamera(60, viewport.clientWidth / viewport.clientHeight, 0.1, 1000);
        camera.position.set(5, 5, 5);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(viewport.clientWidth, viewport.clientHeight);
        viewport.appendChild(renderer.domElement);

        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshBasicMaterial({ color: 0x00ff88, wireframe: true });
        const coreMesh = new THREE.Mesh(geometry, material);
        scene.add(coreMesh);

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        /* ==========================================
           PYODIDE
        ========================================== */
        let pyodideInstance;
        async function initPythonEngine() {
            systemLog("Booting Pyodide Engine...", "yellow");
            try {
                pyodideInstance = await loadPyodide();
                await pyodideInstance.loadPackage("micropip");
                const micropip = pyodideInstance.pyimport("micropip");
                await micropip.install('sympy');
                await micropip.install('numpy');
                document.getElementById('indicator-py').classList.add('active');
                systemLog("Python Engine Active.", "#00ff88");
            } catch (err) {
                systemLog("Engine Boot Failed: " + err, "red");
            }
        }
        initPythonEngine();

        /* ==========================================
           EXECUTION
        ========================================== */
        async function executeLogic() {
            const input = document.getElementById('physics-input').value.trim();
            if (!input) return;

            if (input.startsWith("auth ")) {
                window.githubToken = input.split(" ")[1];
                systemLog("Factory Access Granted.", "#00ff88");
                document.getElementById('physics-input').value = "";
                return;
            }

            const cmd = input.toLowerCase();

            if (cmd.includes("search") || cmd.includes("find")) {
                MasterCreator.exportInvention("Searcher", MasterCreator.researcher);
                systemLog("Opening Search Engine...", "#00ff88");
            } else if (cmd.includes("map") || cmd.includes("where")) {
                MasterCreator.exportInvention("Atlas", MasterCreator.map);
                systemLog("Opening Global Map...", "#00ff88");
            } else if (cmd.includes("write") || cmd.includes("note")) {
                MasterCreator.exportInvention("Notepad", MasterCreator.writer);
                systemLog("Opening Writing Pad...", "#00ff88");
            } else if (cmd.includes("data") || cmd.includes("stat")) {
                MasterCreator.exportInvention("DataAnalyzer", MasterCreator.researcher + "\n// math. db.");
                systemLog("Fetching Statistical Nodes...", "blue");
            } else {
                systemLog(`Processing: ${input}`, "#fff");
            }

            document.getElementById('physics-input').value = "";

            coreMesh.scale.set(
                Math.random() * 1.5 + 0.5,
                Math.random() * 1.5 + 0.5,
                Math.random() * 1.5 + 0.5
            );
        }

        /* ==========================================
           LIBRARIES (VITE-SAFE)
        ========================================== */
        const LIBS = {
            THREE: 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js',
            MAP: 'https://unpkg.com/leaflet/dist/leaflet.js',
            MATH: 'https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.min.js',
            DEXIE: 'https://unpkg.com/dexie/dist/dexie.js',
        };

        // ULTRA-SAFE version â€” no <script> substring anywhere in source
        const getLib = (name) => '&lt;script src="' + LIBS[name] + '"&gt;&lt;/script&gt;';

        /* ==========================================
           MASTER CREATOR
        ========================================== */
        const MasterCreator = {
            researcher: `
                const searchWiki = async (query) => {
                    const response = await fetch('https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=' + query + '&format=json&origin=*');
                    const data = await response.json();
                    document.getElementById('results').innerHTML = data.query.search
                        .map(s => '<div><b>' + s.title + '</b><br>' + s.snippet + '</div>')
                        .join('');
                };
                document.body.innerHTML = \`
                    <div class="glass-card">
                        <input id="q" placeholder="Search Knowledge Base..." style="width:100%;padding:10px;">
                        <button onclick="searchWiki(document.getElementById('q').value)">Search</button>
                        <div id="results" style="max-height:300px; overflow-y:auto; margin-top:10px;"></div>
                    </div>
                \`;
            `,

            writer: `
                document.body.innerHTML = \`
                    <div class="glass-card" style="height:90vh;display:flex;flex-direction:column;">
                        <h2 contenteditable="true">Untitled Document</h2>
                        <div id="editor" contenteditable="true" style="flex-grow:1;outline:none;padding:20px;"></div>
                    </div>
                \`;
            `,

            map: `
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://unpkg.com/leaflet/dist/leaflet.css';
                document.head.appendChild(link);
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet/dist/leaflet.js';
                script.onload = () => {
                    document.body.innerHTML = '<div id="map" style="height:100vh;"></div>';
                    const m = L.map('map').setView([51.505, -0.09], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
                };
                document.head.appendChild(script);
            `,

            inventApp: function(name, type) {
                systemLog(\`Synthesizing Native \${type}: \${name}...\`, "yellow");
            },

            exportInvention: function(name, logic) {
                let injectedLibs = '';
                if (logic.includes('THREE')) injectedLibs += getLib('THREE');
                if (logic.includes('L.map')) injectedLibs += getLib('MAP');
                if (logic.includes('math.')) injectedLibs += getLib('MATH');
                if (logic.includes('db.')) injectedLibs += getLib('DEXIE');

                const content = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>' + name + ' - Generated by PhyArch</title>' +
                    injectedLibs +
                    '<style>body{background:#050507;color:#00ff88;font-family:monospace;margin:0;overflow:hidden;}#status-node{position:fixed;top:0;width:100%;background:rgba(0,20,10,0.95);border-bottom:1px solid #00ff88;padding:8px;font-size:11px;z-index:10000;display:flex;justify-content:space-between;}.glass-card{background:rgba(20,25,20,0.9);border:1px solid #00ff88;margin:60px 20px;padding:20px;border-radius:8px;}</style></head>' +
                    '<body><div id="status-node"><span>SYSTEM: SIMULATION READY</span><span id="boot-status">Waking Engines...</span></div>' +
                    '<div class="glass-card"><h1>' + name + '</h1><hr style="border-color:#333"><div id="app-root"></div></div>' +
                    '<script>window.onload = () => { const time = (performance.now()/1000).toFixed(2); document.getElementById("boot-status").innerText = time + "s Boot"; };</script>' +
                    '<script>' + logic + '</script></body></html>';

                const blob = new Blob([content], { type: 'text/html' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = name + ".html";
                link.click();
                systemLog("Invention " + name + " birthed successfully.", "#00ff88");
    }
};

        /* ==========================================
           UTILITIES
        ========================================== */
        window.addEventListener('resize', () => {
            camera.aspect = viewport.clientWidth / viewport.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(viewport.clientWidth, viewport.clientHeight);
        });

        window.quickInvent = function(name, type) {
            const input = document.getElementById('physics-input');
            if (input) {
                input.value = `invent ${name} ${type}`;
                executeLogic();
            }
        };

        systemLog("PhyArch Builder v1.0 ready.", "#00ff88");

        /* ==========================================
           PYODIDE ENGINE
        ========================================== */
        let pyodideInstance;

        async function initPythonEngine() {
            systemLog("Booting Pyodide Engine...", "yellow");
            try {
                pyodideInstance = await loadPyodide();
                await pyodideInstance.loadPackage("micropip");
                const micropip = pyodideInstance.pyimport("micropip");
                await micropip.install('sympy');
                await micropip.install('numpy');

                document.getElementById('indicator-py').classList.add('active');
                systemLog("Python Engine Active.", "#00ff88");
            } catch (err) {
                systemLog("Engine Boot Failed: " + err, "red");
            }
        }
        initPythonEngine();

        /* ==========================================
           EXECUTION BRIDGE
        ========================================== */
        async function executeLogic() {
            const input = document.getElementById('physics-input').value.trim();
            if (!input) return;

            // Authentication
            if (input.startsWith("auth ")) {
                window.githubToken = input.split(" ")[1];
                systemLog("Factory Access Granted.", "#00ff88");
                document.getElementById('physics-input').value = "";
                return;
            }

            // Inventions
            const cmd = input.toLowerCase();

            if (cmd.includes("search") || cmd.includes("find")) {
                MasterCreator.exportInvention("Searcher", MasterCreator.researcher);
                systemLog("Opening Search Engine...", "#00ff88");
                document.getElementById('physics-input').value = "";
                return;
            }
            if (cmd.includes("map") || cmd.includes("where")) {
                MasterCreator.exportInvention("Atlas", MasterCreator.map);
                systemLog("Opening Global Map...", "#00ff88");
                document.getElementById('physics-input').value = "";
                return;
            }
            if (cmd.includes("write") || cmd.includes("note")) {
                MasterCreator.exportInvention("Notepad", MasterCreator.writer);
                systemLog("Opening Writing Pad...", "#00ff88");
                document.getElementById('physics-input').value = "";
                return;
            }
            if (cmd.includes("data") || cmd.includes("stat")) {
                MasterCreator.exportInvention("DataAnalyzer", MasterCreator.researcher + "\n// math. db.");
                systemLog("Fetching Statistical Nodes...", "blue");
                document.getElementById('physics-input').value = "";
                return;
            }

            systemLog(`Processing: ${input}`, "#fff");
            document.getElementById('physics-input').value = "";

            // Visual feedback
            coreMesh.scale.set(
                Math.random() * 1.5 + 0.5,
                Math.random() * 1.5 + 0.5,
                Math.random() * 1.5 + 0.5
            );
        }

/* ==========================================
   LIBRARY REPOSITORY (Vite-safe)
========================================== */
const LIBS = {
    THREE: 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js',
    MAP: 'https://unpkg.com/leaflet/dist/leaflet.js',
    MATH: 'https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.min.js',
    DEXIE: 'https://unpkg.com/dexie/dist/dexie.js'
};

const getLib = (name) => {
    const s = document.createElement('script');
    s.src = LIBS[name];
    s.async = false; 
    document.head.appendChild(s);
    return ""; 
};

        /* ==========================================
           MASTER CREATOR (AUTO-INVENT)
        ========================================== */
        const MasterCreator = {
            researcher: `
                const searchWiki = async (query) => {
                    const response = await fetch('https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=' + query + '&format=json&origin=*');
                    const data = await response.json();
                    document.getElementById('results').innerHTML = data.query.search
                        .map(s => '<div><b>' + s.title + '</b><br>' + s.snippet + '</div>')
                        .join('');
                };
                document.body.innerHTML = \`
                    <div class="glass-card">
                        <input id="q" placeholder="Search Knowledge Base..." style="width:100%;padding:10px;">
                        <button onclick="searchWiki(document.getElementById('q').value)">Search</button>
                        <div id="results" style="max-height:300px; overflow-y:auto; margin-top:10px;"></div>
                    </div>
                \`;
            `,

            writer: `
                document.body.innerHTML = \`
                    <div class="glass-card" style="height:90vh;display:flex;flex-direction:column;">
                        <h2 contenteditable="true">Untitled Document</h2>
                        <div id="editor" contenteditable="true" style="flex-grow:1;outline:none;padding:20px;"></div>
                    </div>
                \`;
            `,

            map: `
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://unpkg.com/leaflet/dist/leaflet.css';
                document.head.appendChild(link);

                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet/dist/leaflet.js';
                script.onload = () => {
                    document.body.innerHTML = '<div id="map" style="height:100vh;"></div>';
                    const m = L.map('map').setView([51.505, -0.09], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
                };
                document.head.appendChild(script);
            `,

            inventApp: function(name, type) {
                systemLog(\`Synthesizing Native \${type}: \${name}...\`, "yellow");
            },

            exportInvention: function(name, logic) {
                let injectedLibs = '';
                if (logic.includes('THREE')) injectedLibs += getLib('THREE');
                if (logic.includes('L.map')) injectedLibs += getLib('MAP');
                if (logic.includes('math.')) injectedLibs += getLib('MATH');
                if (logic.includes('db.')) injectedLibs += getLib('DEXIE');

                const content = '<!DOCTYPE html>' +
                    '<html lang="en">' +
                    '<head>' +
                        '<meta charset="UTF-8">' +
                        '<title>' + name + ' - Generated by PhyArch</title>' +
                        injectedLibs +
                        '<style>' +
                            'body { background:#050507; color:#00ff88; font-family:monospace; margin:0; overflow:hidden; }' +
                            '#status-node { position:fixed; top:0; width:100%; background:rgba(0,20,10,0.95); border-bottom:1px solid #00ff88; padding:8px; font-size:11px; z-index:10000; display:flex; justify-content:space-between; }' +
                            '.glass-card { background:rgba(20,25,20,0.9); border:1px solid #00ff88; margin:60px 20px; padding:20px; border-radius:8px; }' +
                        '</style>' +
                    '</head>' +
                    '<body>' +
                        '<div id="status-node">' +
                            '<span>SYSTEM: SIMULATION READY</span>' +
                            '<span id="boot-status">Waking Engines...</span>' +
                        '</div>' +
                        '<div class="glass-card">' +
                            '<h1>' + name + '</h1>' +
                            '<hr style="border-color:#333">' +
                            '<div id="app-root"></div>' +
                        '</div>' +
                        '<script>window.onload = () => { const time = (performance.now()/1000).toFixed(2); document.getElementById("boot-status").innerText = time + "s Boot"; };</script>' +
                        '<script>' + logic + '</script>' +
                    '</body>' +
                    '</html>';

                const blob = new Blob([content], { type: 'text/html' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = name + ".html";
                link.click();
                systemLog("Invention " + name + " birthed successfully.", "#00ff88");
            }
        };

        /* ==========================================
           WINDOW UTILITIES
        ========================================== */
        window.addEventListener('resize', () => {
            camera.aspect = viewport.clientWidth / viewport.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(viewport.clientWidth, viewport.clientHeight);
        });

        window.quickInvent = function(name, type) {
            const input = document.getElementById('physics-input');
            if (input) {
                input.value = `invent ${name} ${type}`;
                executeLogic();
            }
        };

        // Final ready message
        systemLog("PhyArch Builder v1.0 ready. Type a command or press a button.", "#00ff88");
    </script>
</body>
</html>        renderer.setSize(viewport.clientWidth, viewport.clientHeight);
        viewport.appendChild(renderer.domElement);

        // Core visual object (Placeholder for physics manipulation)
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshBasicMaterial({ color: 0x00ff88, wireframe: true });
        const coreMesh = new THREE.Mesh(geometry, material);
        scene.add(coreMesh);

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        /* ==========================================
           MODULE 3: PYTHON (PYODIDE) ENGINE
        ========================================== */
        let pyodideInstance;
        
        async function initPythonEngine() {
            systemLog("Booting Pyodide Engine...", "yellow");
            try {
                pyodideInstance = await loadPyodide();
                await pyodideInstance.loadPackage("micropip");
                const micropip = pyodideInstance.pyimport("micropip");
                
                systemLog("Installing SymPy & NumPy (Local Sandbox)...", "yellow");
                await micropip.install('sympy');
                await micropip.install('numpy');
                
                document.getElementById('indicator-py').classList.add('active');
                systemLog("Python Engine Active. Ready for complex logic.", "#00ff88");
            } catch (err) {
                systemLog("Engine Boot Failed: " + err, "red");
            }
        }
        
        // Start engine in background
        initPythonEngine();
        /* =============================================
   MODULE 4: EXECUTION BRIDGE (MASTER)
================================================ */
async function executeLogic() {
    const input = document.getElementById('physics-input').value;
    if(!input) return;

    // 1. Handle Authentication
    if (input.startsWith("auth ")) {
        const token = input.split(" ")[1];
        window.githubToken = token;
        systemLog("Factory Access Granted. Hands are active.", "#00ff88");
        document.getElementById('physics-input').value = "";
        return;
    }

    // 2. Handle Inventions
    let cmd = input.toLowerCase();

    if (cmd.includes("search") || cmd.includes("find")) {
        MasterCreator.exportInvention("Searcher", MasterCreator.researcher);
        systemLog("Opening Search Engine...", "#00ff88");
    } else if (cmd.includes("map") || cmd.includes("where")) {
        MasterCreator.exportInvention("Atlas", MasterCreator.map);
        systemLog("Opening Global Map...", "#00ff88");
    } else if (cmd.includes("write") || cmd.includes("note")) {
        MasterCreator.exportInvention("Notepad", MasterCreator.writer);
        systemLog("Opening Writing Pad...", "#00ff88");
    } else if (cmd.includes("data") || cmd.includes("stat")) {
        MasterCreator.exportInvention("DataAnalyzer", MasterCreator.researcher + "\n // math. db.");
        systemLog("Fetching Statistical Nodes...", "blue");
    }

    systemLog(`Processing: ${input}`, "#fff");
    document.getElementById('physics-input').value = "";

    // Visual feedback trigger
    if(window.coreMesh) {
        coreMesh.scale.set(Math.random()*1.5 + 0.5, Math.random()*1.5 + 0.5, Math.random()*1.5 + 0.5);
    }
}

// Central Library Repository
const LIBS = {
    THREE: 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js',
    MAP: 'https://unpkg.com/leaflet/dist/leaflet.js',
    MATH: 'https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.min.js',
    DEXIE: 'https://unpkg.com/dexie/dist/dexie.js',
};

/** * FIX: Using string concatenation to prevent Vite's HTML parser 
 * from misidentifying this as a real script tag.
 */
const getLib = (name) => '<scr' + 'ipt src="' + LIBS[name] + '"></scr' + 'ipt>';

/* =============================================
   MODULE 6: MASTER CREATOR (AUTO-INVENT)
================================================ */
const MasterCreator = {
    researcher: `
        const searchWiki = async (query) => {
            const const getLib = (name) => '<scr' + 'ipt src="' + LIBS[name] + '"></scr' + 'ipt>';
            const data = await response.json();
            document.getElementById('results').innerHTML = data.query.search.map(s => '<div><b>'+s.title+'</b><br>'+s.snippet+'</div>').join('');
        };
        document.body.innerHTML = \`
            <div class="glass-card">
                <input id="q" placeholder="Search Knowledge Base...">
                <button onclick="searchWiki(document.getElementById('q').value)">Search</button>
                <div id="results" style="max-height:300px; overflow-y:auto;"></div>
            </div>
        \`;
    `,

    writer: `
        document.body.innerHTML = \`
            <div class="glass-card" style="height: 90vh; display: flex; flex-direction: column;">
                <h2 contenteditable="true">Untitled Document</h2>
                <div id="editor" contenteditable="true" style="flex-grow: 1; outline: none; padding: 20px;">
                    Start typing your sovereign thoughts here...
                </div>
            </div>
        \`;
    `,

    inventApp: function(name, type) {
        systemLog(\`Synthesizing Native \${type}: \${name}...\`, "yellow");
        // Logic for native app assembly goes here
    },

exportInvention: function(name, logic) {
        let injectedLibs = '';
        if (logic.includes('THREE')) injectedLibs += getLib('THREE');
        if (logic.includes('L.map')) injectedLibs += getLib('MAP');
        if (logic.includes('math.')) injectedLibs += getLib('MATH');
        if (logic.includes('db.'))   injectedLibs += getLib('DEXIE');

        var content = '<!DOCTYPE html>' +
            '<html>' +
            '<head>' +
            '<meta charset="UTF-8">' +
            '<title>' + name + ' - Generated</title>' +
            injectedLibs +
            '<style>' +
            'body { background:#050507; color:#00ff88; font-family:monospace; margin:0; padding:20px; }' +
            '.glass-card { background:rgba(20,20,25,0.8); border:1px solid #333; padding:20px; border-radius:8px; }' +
            '#status-node { position:fixed; top:0; left:0; width:100%; background:#000; border-bottom:1px solid #00ff88; padding:5px; font-size:10px; display:flex; justify-content:space-between; z-index:1000; }' +
            '</style>' +
            '</head>' +
            '<body>' +
            '<div id="status-node"><span>SYSTEM ACTIVE</span><span id="boot-status">Waking...</span></div>' +
            '<div class="glass-card">' +
            '<h1>' + name + '</h1>' +
            '<hr style="border:0; border-top:1px solid #222;">' +
            '<div id="app-root"></div>' +
            '</div>' +
            '<scr' + 'ipt>' +
            'window.onload = () => {' +
            'const time = (performance.now()/1000).toFixed(2);' +
            'document.getElementById("boot-status").innerText = time + "s Boot";' +
            logic + 
            '};' +
            '</scr' + 'ipt>' +
            '</body>' +
            '</html>';

        const blob = new Blob([content], { type: 'text/html' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = name + ".html";
        link.click();
        systemLog("Invention " + name + " birthed successfully.", "#00ff88");
    }
};

// Handle Resizing
window.addEventListener('resize', () => {
    if(window.camera && window.renderer) {
        camera.aspect = viewport.clientWidth / viewport.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(viewport.clientWidth, viewport.clientHeight);
    }
});

// Quick Invent Logic
window.quickInvent = function(name, type) {
    const input = document.getElementById('physics-input');
    if (input) {
        input.value = \`invent \${name} \${type}\`;
        executeLogic();
    }
};
// ... all your previous logic (Pyodide, MasterCreator, etc.) ...

    function animate() {
        requestAnimationFrame(animate);
        if (window.renderer && window.scene && window.camera) {
            renderer.render(scene, camera);
        }
    }
animate(); // This starts the loop once everything is loaded

</script>
</body>
</html>
