<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhyArch Omni v2.7 â€” Pulse & Echo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <style>
        :root {
            --bg: #020205;
            --panel: rgba(8,8,15,0.98);
            --accent: #00ff88;
            --accent2: #00ccff;
            --danger: #ff3366;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'JetBrains Mono', 'fira code', monospace; }
        body { background: var(--bg); color: #eee; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        header {
            height: 50px;
            background: #000;
            border-bottom: 1px solid #1a1a1a;
            display: flex; align-items: center; padding: 0 20px;
            justify-content: space-between; z-index: 100;
        }
        .logo { font-size: 16px; letter-spacing: 3px; font-weight: 800; color: #555; }
        .logo span { color: var(--accent); }

        .main { flex: 1; display: flex; position: relative; }
        #viewport { flex: 1; background: #000; cursor: crosshair; }
        
        .sidebar {
            width: 300px; background: var(--panel); border-left: 1px solid #1a1a1a;
            padding: 15px; display: flex; flex-direction: column; gap: 15px; font-size: 12px;
        }
        .glass { background: rgba(255,255,255,0.02); border: 1px solid #222; border-radius: 8px; padding: 12px; }

        #console { height: 220px; background: #000; border-top: 1px solid #1a1a1a; display: flex; flex-direction: column; }
        #log { flex: 1; padding: 10px; overflow-y: auto; color: #666; font-size: 11px; }
        .input-row { display: flex; padding: 10px; gap: 10px; background: #050505; }
        input[type="text"] { 
            flex: 1; background: #111; border: 1px solid #222; color: var(--accent); 
            padding: 8px 12px; border-radius: 4px; outline: none;
        }

        .btn {
            background: transparent; color: var(--accent); border: 1px solid #333;
            padding: 5px 12px; border-radius: 4px; cursor: pointer; transition: 0.2s;
        }
        .btn:hover { border-color: var(--accent); background: rgba(0,255,136,0.05); }
        .btn-active { background: var(--accent) !important; color: #000 !important; }
    </style>
</head>
<body>

<header>
    <div class="logo">PHY<span>ARCH</span> v2.7</div>
    <div style="display:flex; gap:10px;">
        <button id="toggleAudio" class="btn">AUDIO: OFF</button>
        <button id="toggleField" class="btn">FIELD: OFF</button>
        <button id="resetBtn" class="btn" style="color:var(--danger)">WIPE</button>
    </div>
</header>

<div class="main">
    <div id="viewport"></div>
    <div class="sidebar">
        <div class="glass">
            <h4 style="color:var(--accent2)">SPATIAL HASH STATS</h4>
            <div id="perf-stats" style="margin-top:5px; opacity:0.7;">Active Objects: 0<br>Grid Cells: 0</div>
        </div>
        <div class="glass">
            <h4 style="color:var(--accent)">INSPECTOR</h4>
            <div id="inspector" style="margin-top:8px;">No target locked.</div>
        </div>
        <div class="glass" style="flex:1; display:flex; flex-direction:column;">
            <h4 style="color:var(--accent2)">PYTHON PATTERN GEN</h4>
            <textarea id="pyCode" style="width:100%; flex:1; background:#000; border:1px solid #222; color:var(--accent2); margin-top:10px; padding:8px; font-size:10px;">
# Spiral Formation
import math
for i in range(50):
    angle = i * 0.5
    r = i * 0.5
    js.Omni.spawn('box', 1, 
        pos={'x': math.cos(angle)*r, 'y': 10+i, 'z': math.sin(angle)*r},
        color=0x00ccff, size=0.8)
            </textarea>
            <button id="runPyBtn" class="btn" style="margin-top:10px; width:100%;">BOOTING PYTHON...</button>
        </div>
    </div>
</div>

<div id="console">
    <div id="log"></div>
    <div class="input-row">
        <input type="text" id="cmd" placeholder="Execute command...">
    </div>
</div>

<script>
// ====================== AUDIO ENGINE ======================
const AudioEngine = {
    ctx: null,
    enabled: false,
    init() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    },
    playCollision(impact) {
        if (!this.enabled || !this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(100 + impact * 200, this.ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(10, this.ctx.currentTime + 0.1);
        gain.gain.setValueAtTime(Math.min(0.2, impact * 0.05), this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + 0.1);
    }
};

// ====================== SPATIAL HASHING ======================
// Reduces collision complexity from O(n^2) to O(n)
class SpatialHash {
    constructor(cellSize) {
        this.cellSize = cellSize;
        this.grid = new Map();
    }
    _key(v) {
        const x = Math.floor(v.x / this.cellSize);
        const y = Math.floor(v.y / this.cellSize);
        const z = Math.floor(v.z / this.cellSize);
        return `${x},${y},${z}`;
    }
    clear() { this.grid.clear(); }
    insert(obj) {
        const key = this._key(obj.mesh.position);
        if (!this.grid.has(key)) this.grid.set(key, []);
        this.grid.get(key).push(obj);
    }
    getNearby(obj) {
        const key = this._key(obj.mesh.position);
        return this.grid.get(key) || [];
    }
}

// ====================== ENGINE ======================
let scene, camera, renderer, controls, coreMesh;
let objects = [];
let fieldActive = false;
const hash = new SpatialHash(5);

const Omni = {
    init() {
        const vp = document.getElementById('viewport');
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(50, vp.clientWidth/vp.clientHeight, 0.1, 1000);
        camera.position.set(40, 40, 40);
        
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(vp.clientWidth, vp.clientHeight);
        vp.appendChild(renderer.domElement);
        
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const light = new THREE.PointLight(0x00ff88, 1, 100);
        light.position.set(10, 20, 10);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));
        scene.add(new THREE.GridHelper(100, 20, 0x222222, 0x111111));

        const coreGeo = new THREE.SphereGeometry(4, 32, 32);
        const coreMat = new THREE.MeshPhongMaterial({ color: 0x00ff88, wireframe: true });
        coreMesh = new THREE.Mesh(coreGeo, coreMat);
        scene.add(coreMesh);

        this.animate();
    },

    spawn(type, count, opts = {}) {
        for(let i=0; i<count; i++) {
            const size = opts.size || 1.5;
            const geo = type === 'sphere' ? new THREE.SphereGeometry(size, 8, 8) : new THREE.BoxGeometry(size, size, size);
            const mat = new THREE.MeshPhongMaterial({ color: opts.color || 0x00ccff, wireframe: true });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(opts.pos?.x || 0, opts.pos?.y || 20, opts.pos?.z || 0);
            scene.add(mesh);
            objects.push(new PhysicsObject(mesh, size));
        }
    },

    animate() {
        requestAnimationFrame(() => Omni.animate());
        
        // Update Spatial Hash
        hash.clear();
        objects.forEach(o => hash.insert(o));

        // Physics Update
        objects.forEach(o => o.update(hash, fieldActive));
        
        document.getElementById('perf-stats').innerHTML = `Objects: ${objects.length}<br>Complexity: O(${objects.length})`;
        
        controls.update();
        renderer.render(scene, camera);
    }
};

class PhysicsObject {
    constructor(mesh, size) {
        this.mesh = mesh;
        this.size = size;
        this.velocity = new THREE.Vector3((Math.random()-0.5)*0.2, 0, (Math.random()-0.5)*0.2);
    }
    update(spatialHash, field) {
        if (field) {
            const dir = new THREE.Vector3(0,0,0).sub(this.mesh.position).normalize();
            this.velocity.add(dir.multiplyScalar(0.05));
        } else {
            this.velocity.y -= 0.015; // Gravity
        }

        this.mesh.position.add(this.velocity);

        // Floor
        if (this.mesh.position.y < this.size/2) {
            this.mesh.position.y = this.size/2;
            this.velocity.y *= -0.6;
        }

        // Optimized Collision via Spatial Hash
        const nearby = spatialHash.getNearby(this);
        nearby.forEach(other => {
            if (other === this) return;
            const dist = this.mesh.position.distanceTo(other.mesh.position);
            if (dist < (this.size + other.size)/2) {
                const impact = this.velocity.length();
                if (impact > 0.1) AudioEngine.playCollision(impact);
                
                const push = this.mesh.position.clone().sub(other.mesh.position).normalize();
                this.velocity.add(push.multiplyScalar(0.02));
            }
        });
    }
}

// ====================== BOOT ======================
(async () => {
    Omni.init();
    const pyBtn = document.getElementById('runPyBtn');
    try {
        const pyodide = await loadPyodide();
        window.Omni = Omni;
        pyodide.globals.set("js", window);
        pyBtn.textContent = "RUN PYTHON PATTERN";
        pyBtn.onclick = () => pyodide.runPython(document.getElementById('pyCode').value);
    } catch(e) { pyBtn.textContent = "PY FAIL"; }

    document.getElementById('toggleAudio').onclick = (e) => {
        if (!AudioEngine.ctx) AudioEngine.init();
        AudioEngine.enabled = !AudioEngine.enabled;
        e.target.classList.toggle('btn-active');
        e.target.textContent = `AUDIO: ${AudioEngine.enabled ? 'ON' : 'OFF'}`;
    };

    document.getElementById('toggleField').onclick = (e) => {
        fieldActive = !fieldActive;
        e.target.classList.toggle('btn-active');
        e.target.textContent = `FIELD: ${fieldActive ? 'ON' : 'OFF'}`;
    };
    
    document.getElementById('resetBtn').onclick = () => location.reload();
})();
</script>
</body>
</html>
